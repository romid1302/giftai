<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-markdown/umd/react-markdown.min.js"></script>
    <!-- Syntax highlighting (PrismJS or Highlight.js) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <style>
        * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: #0f0f10;
  color: #fff;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

#root {
  width: 100%;
  height: 100%;
  max-width: 1400px;
  max-height: 900px;
}

/* --- App Container --- */
.app-container {
  display: flex;
  width: 100%;
  height: 100%;
  background: #1a1a1d;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
  border: 1px solid #2d2d32;
}

/* --- Upload Section --- */
.upload-section {
  width: 30%;
  background: #141416;
  border-right: 1px solid #2a2a2f;
  padding: 20px;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  color: #ddd;
}

.upload-section h2 {
  color: #6c63ff;
  margin-bottom: 6px;
}

.upload-area {
  border: 2px dashed #6c63ff;
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  margin-bottom: 20px;
  background: #1f1f23;
  transition: all 0.3s ease;
}

.upload-area:hover {
  background: #26262c;
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 42px;
  color: #6c63ff;
  margin-bottom: 10px;
}

.upload-button {
  background: #6c63ff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
  font-weight: 600;
  transition: 0.3s;
}

.upload-button:hover {
  background: #554fd8;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #1e1e22;
  border-radius: 8px;
  margin-bottom: 8px;
  transition: all 0.2s ease;
  color: #ddd;
}

.file-item:hover {
  background: #27272d;
}

.remove-file {
  color: #ff4757;
  cursor: pointer;
  font-weight: bold;
  padding: 5px;
  transition: 0.2s;
}
.remove-file:hover {
  transform: scale(1.2);
}

/* --- Chat Section --- */
.chat-section {
  width: 70%;
  display: flex;
  flex-direction: column;
  background: #1a1a1d;
}

.chat-header {
  padding: 18px;
  border-bottom: 1px solid #2a2a2f;
  background: linear-gradient(135deg, #6c63ff, #554fd8);
  color: white;
  font-weight: 600;
  font-size: 18px;
}

/* --- Messages --- */
.chat-messages {
  flex-grow: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.message {
  max-width: 70%;
  padding: 14px 18px;
  border-radius: 14px;
  line-height: 1.4;
  font-size: 15px;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.user-message {
  align-self: flex-end;
  background: #6c63ff;
  color: white;
  border-bottom-right-radius: 6px;
}

.ai-message {
  align-self: flex-start;
  background: #2a2a2f;
  color: #eee;
  border-bottom-left-radius: 6px;
}

/* --- Typing Indicator --- */
.typing-indicator {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: #2a2a2f;
  border-radius: 12px;
  align-self: flex-start;
  max-width: 70%;
}

.typing-dot {
  width: 8px;
  height: 8px;
  background-color: #6c63ff;
  border-radius: 50%;
  margin: 0 3px;
  animation: typingAnimation 1.4s infinite ease-in-out;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingAnimation {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
  30% { transform: translateY(-5px); opacity: 1; }
}

/* --- Chat Input --- */
.chat-input {
  padding: 15px;
  border-top: 1px solid #2a2a2f;
  background: #141416;
  display: flex;
  gap: 10px;
}

.message-input {
  flex-grow: 1;
  padding: 12px 18px;
  border: none;
  border-radius: 30px;
  outline: none;
  font-size: 15px;
  background: #222226;
  color: #fff;
  transition: 0.3s;
}
.message-input:focus {
  background: #2a2a2f;
  box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.4);
}

.send-button {
  background: #6c63ff;
  color: white;
  border: none;
  width: 46px;
  height: 46px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 18px;
  transition: 0.3s;
}
.send-button:hover {
  background: #554fd8;
  transform: scale(1.1);
}

/* --- Scrollbar --- */
.chat-messages::-webkit-scrollbar {
  width: 6px;
}
.chat-messages::-webkit-scrollbar-thumb {
  background: #6c63ff;
  border-radius: 3px;
}

    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // API service with actual endpoints
        const ApiService = {
            // Upload file API call
            uploadFile: async (file) => {
                const formData = new FormData();
                formData.append('pdf', file);
                
                try {
                    const response = await fetch('http://localhost:8000/upload/pdf', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    return {
                        success: true,
                        message: data.message || `File "${file.name}" uploaded successfully`,
                        fileId: Math.random().toString(36).substring(2, 9)
                    };
                } catch (error) {
                    console.error("Error uploading file:", error);
                    return {
                        success: false,
                        message: `Failed to upload file: ${error.message}`
                    };
                }
            },
            
            // Chat API call - FIXED: Using "query" parameter instead of "message"
            sendMessage: async (query) => {
                try {
                    console.log("Sending query:", query);
                    
                    const response = await fetch('http://localhost:8000/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query }), // Changed from "message" to "query"
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log("API response:", data);
                    
                    return {
                        success: true,
                        message: data.answer
                    };
                } catch (error) {
                    console.error("Error sending message:", error);
                    return {
                        success: false,
                        message: `Sorry, I encountered an error: ${error.message}`
                    };
                }
            }
        };

        const FileUploadSection = () => {
            const [files, setFiles] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [uploadError, setUploadError] = useState(null);
            const fileInputRef = useRef(null);
            
            const handleFileUpload = async (event) => {
                const uploadedFiles = Array.from(event.target.files);
                if (uploadedFiles.length === 0) return;
                
                setUploading(true);
                setUploadError(null);
                
                for (const file of uploadedFiles) {
                    try {
                        // API call to upload file
                        const result = await ApiService.uploadFile(file);
                        
                        if (result.success) {
                            setFiles(prev => [...prev, {
                                file,
                                id: result.fileId,
                                uploadedAt: new Date().toLocaleTimeString()
                            }]);
                            console.log(result.message);
                        } else {
                            setUploadError(result.message);
                        }
                    } catch (error) {
                        console.error("Error uploading file:", error);
                        setUploadError(error.message);
                    }
                }
                
                setUploading(false);
            };
            
            const handleRemoveFile = (index) => {
                const updatedFiles = [...files];
                updatedFiles.splice(index, 1);
                setFiles(updatedFiles);
            };
            
            const handleDragOver = (event) => {
                event.preventDefault();
                event.currentTarget.classList.add('drag-over');
            };
            
            const handleDragLeave = (event) => {
                event.preventDefault();
                event.currentTarget.classList.remove('drag-over');
            };
            
            const handleDrop = (event) => {
                event.preventDefault();
                event.currentTarget.classList.remove('drag-over');
                const droppedFiles = Array.from(event.dataTransfer.files);
                
                if (droppedFiles.length > 0) {
                    const event = { target: { files: droppedFiles } };
                    handleFileUpload(event);
                }
            };
            
            return (
                <div className="upload-section">
                    <h2>Upload Files</h2>
                    <p>Upload PDF documents for analysis</p>
                    
                    <div 
                        className="upload-area"
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                    >
                        <div className="upload-icon">📁</div>
                        <p>Drag & drop PDF files here or click to browse</p>
                        <input
                            type="file"
                            ref={fileInputRef}
                            style={{ display: 'none' }}
                            onChange={handleFileUpload}
                            multiple
                            disabled={uploading}
                            accept=".pdf"
                        />
                        <button 
                            className="upload-button"
                            onClick={() => fileInputRef.current.click()}
                            disabled={uploading}
                        >
                            {uploading ? 'Uploading...' : 'Browse Files'}
                        </button>
                        {uploadError && (
                            <div className="error-message">
                                {uploadError}
                            </div>
                        )}
                    </div>
                    
                    <div className="uploaded-files">
                        <h3>Uploaded Files ({files.length})</h3>
                        {files.map((file, index) => (
                            <div key={index} className="file-item">
                                <span className="file-name">{file.file.name}</span>
                                <span 
                                    className="remove-file"
                                    onClick={() => handleRemoveFile(index)}
                                >
                                    ×
                                </span>
                            </div>
                        ))}
                    </div>
                    
                    
                </div>
            );
        };
        
        const ChatSection = () => {
            const [messages, setMessages] = useState([
                { id: 1, text: "Hello! I'm your AI assistant. How can I help you today?", sender: 'ai' },
            ]);
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [chatError, setChatError] = useState(null);
            const messagesEndRef = useRef(null);
            
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            useEffect(() => {
                scrollToBottom();
            }, [messages]);
            
            const handleSendMessage = async () => {
                if (inputText.trim() === '') return;
                
                // Add user message
                const newUserMessage = {
                    id: Date.now(),
                    text: inputText,
                    sender: 'user'
                };
                
                setMessages([...messages, newUserMessage]);
                setInputText('');
                setIsTyping(true);
                setChatError(null);
                
                try {
                    // API call to send message - FIXED: Using "query" parameter
                    const result = await ApiService.sendMessage(inputText);
                    
                    if (result.success) {
                        const aiResponse = {
                            id: Date.now() + 1,
                            text: result.message,
                            sender: 'ai'
                        };
                        setMessages(prev => [...prev, aiResponse]);
                    } else {
                        setChatError(result.message);
                    const errorResponse = {
                        id: Date.now() + 1,
                        text: result.message,
                        sender: 'ai'
                    };
                    setMessages(prev => [...prev, errorResponse]);
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                    setChatError(error.message);
                    
                    const errorResponse = {
                        id: Date.now() + 1,
                        text: "Sorry, I encountered an error processing your request.",
                        sender: 'ai'
                    };
                    setMessages(prev => [...prev, errorResponse]);
                } finally {
                    setIsTyping(false);
                }
            };
            
            const handleKeyPress = (event) => {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            };
            
            return (
                <div className="chat-section">
                    <div className="chat-header">
                        <h2>HBG AI Assistant</h2>
                    </div>
                    
                    <div className="chat-messages">
                        {messages.map(message => (
                            <div 
                                key={message.id} 
                                className={`message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`}
                            >
                                  <ReactMarkdown
    components={{
      h1: ({node, ...props}) => <h1 style={{fontSize: "1.6rem", fontWeight: "600", marginBottom: "12px", color: "#222"}} {...props} />,
      h2: ({node, ...props}) => <h2 style={{fontSize: "1.3rem", fontWeight: "600", marginBottom: "10px", color: "#333"}} {...props} />,
      p: ({node, ...props}) => <p style={{marginBottom: "12px", lineHeight: "1.6"}} {...props} />,
      ul: ({node, ...props}) => <ul style={{paddingLeft: "20px", marginBottom: "12px"}} {...props} />,
      ol: ({node, ...props}) => <ol style={{paddingLeft: "20px", marginBottom: "12px"}} {...props} />,
      li: ({node, ...props}) => <li style={{marginBottom: "6px"}} {...props} />,
      strong: ({node, ...props}) => <strong style={{fontWeight: "600", color: "#000"}} {...props} />,
      code: ({inline, className, children, ...props}) => {
        if (inline) {
          return (
            <code style={{
              background: "#f4f4f4",
              padding: "2px 6px",
              borderRadius: "4px",
              fontSize: "0.9rem"
            }} {...props}>
              {children}
            </code>
          );
        }
        return (
          <pre style={{
            background: "#1e1e1e",
            color: "#f8f8f2",
            padding: "12px",
            borderRadius: "8px",
            overflowX: "auto",
            marginBottom: "14px"
          }}>
            <code className={className} {...props}>{children}</code>
          </pre>
        );
      }
    }}
  >
    {message.text}
  </ReactMarkdown>
                            </div>
                        ))}
                        
                        {isTyping && (
                            <div className="typing-indicator">
                                <div className="typing-dot"></div>
                                <div className="typing-dot"></div>
                                <div className="typing-dot"></div>
                            </div>
                        )}
                        
                        {chatError && (
                            <div className="error-message">
                                Error: {chatError}
                            </div>
                        )}
                        
                        <div ref={messagesEndRef} />
                    </div>
                    
                    <div className="chat-input">
                        <input
                            type="text"
                            className="message-input"
                            placeholder="Type your message here..."
                            value={inputText}
                            onChange={(e) => setInputText(e.target.value)}
                            onKeyPress={handleKeyPress}
                            disabled={isTyping}
                        />
                        <button 
                            className="send-button"
                            onClick={handleSendMessage}
                            disabled={isTyping || inputText.trim() === ''}
                        >
                            ↑
                        </button>
                    </div>
                </div>
            );
        };
        
        const App = () => {
            return (
                <div className="app-container">
                    <FileUploadSection />
                    <ChatSection />
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>